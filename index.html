<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ã‚¿ã‚¹ã‚¯ç®¡ç†ï¼ˆéšå±¤æ§‹é€ å¯¾å¿œï¼‰</title>
  <style>
    :root {
      --bar-width: 5px;
      --project-margin: 6px;
      --task-padding: 8px;
      --indent-size: 4px;
    }

    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f7f7f7;
    }

    #app {
      padding: 16px;
      max-width: 800px;
      margin: auto;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    h1 {
      margin: 0;
      font-size: 1.4em;
    }

    button {
      cursor: pointer;
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }

    .project, .task {
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      position: relative;
      margin-top: var(--project-margin);
      padding: var(--task-padding);
    }

    .bar {
      width: var(--bar-width);
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      border-top-left-radius: 5px;
      border-bottom-left-radius: 5px;
    }

    .task-content {
      margin-left: calc(var(--bar-width) + 8px);
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }

    .task-list {
      margin-left: var(--indent-size);
      padding-left: 2px;
      border-left: 1px dashed #ccc;
      margin-top: 4px;
    }

    .icon-btn, .drag-handle {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
    }

    .drag-handle {
      cursor: grab;
    }

    .popup-menu {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 4px 6px;
      z-index: 100;
      display: none;
    }

    .popup-menu button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      margin: 0 3px;
    }

    .completed-title {
      text-decoration: line-through;
      color: #888;
    }

    /* ä½™ç™½ãŒã‚ã¾ã‚Šã§ããªã„ã‚ˆã†ã«è£œæ­£ */
    .project > .task-list,
    .task > .task-list {
      margin-bottom: 4px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="app">
    <header>
  <h1>ã‚¿ã‚¹ã‚¯ç®¡ç†</h1>
  <select id="projectFilter">
    <option value="all">ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>
  </select>
  <button id="addProjectBtn">ï¼‹</button>
</header>

    <main id="projectList"></main>
  </div>
  <script src="script.js"></script>


<script>
  let data = JSON.parse(localStorage.getItem("taskData")) || [];

const projectList = document.getElementById("projectList");
const addProjectBtn = document.getElementById("addProjectBtn");

const colors = ['#FF5722', '#4CAF50', '#2196F3', '#FFC107', '#9C27B0', '#00BCD4', '#FF9800', '#E91E63', '#795548', '#3F51B5'];
const projectFilter = document.getElementById("projectFilter");

projectFilter.addEventListener("change", () => {
  render(); // é¸æŠå¤‰æ›´æ™‚ã«å†æç”»
});

function saveData() {
  localStorage.setItem("taskData", JSON.stringify(data));
}
function createPopupMenu(taskOrProject, parent, index, type) {
  // type: "project" or "task"
  const menu = document.createElement("div");
  menu.className = "popup-menu";

  // ç·¨é›†ãƒœã‚¿ãƒ³
  const editBtn = document.createElement("button");
  editBtn.textContent = "âœï¸";
  editBtn.title = "ç·¨é›†";
  editBtn.onclick = (e) => {
    e.stopPropagation();
    const newName = prompt((type === "project" ? "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ" : "ã‚¿ã‚¹ã‚¯") + "åã‚’ç·¨é›†:", taskOrProject.name);
    if (newName) {
      taskOrProject.name = newName;
      saveData();
      render();
    }
    closePopupMenus();
  };
  menu.appendChild(editBtn);

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒœã‚¿ãƒ³ï¼ˆæœŸé–“ç·¨é›†ãŒã‚ã‚‹å ´åˆï¼‰
  if (type === "task") {
    const periodBtn = document.createElement("button");
    periodBtn.textContent = "ğŸ“…";
    periodBtn.title = "æœŸé–“ç·¨é›†";
    periodBtn.onclick = (e) => {
      e.stopPropagation();
      showPeriodEditDialog(taskOrProject);
      closePopupMenus();
    };
    menu.appendChild(periodBtn);
  }

  // ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³
  const commentBtn = document.createElement("button");
  commentBtn.textContent = "ğŸ’¬";
  commentBtn.title = "ã‚³ãƒ¡ãƒ³ãƒˆ";
  commentBtn.onclick = (e) => {
    e.stopPropagation();
    const newComment = prompt("ã‚³ãƒ¡ãƒ³ãƒˆ:", taskOrProject.comment || "");
    if (newComment !== null) {
      taskOrProject.comment = newComment;
      saveData();
      render();
    }
    closePopupMenus();
  };
  menu.appendChild(commentBtn);

  // ã‚´ãƒŸç®±ï¼ˆå‰Šé™¤ï¼‰ãƒœã‚¿ãƒ³
  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "ğŸ—‘ï¸";
  deleteBtn.title = "å‰Šé™¤";
  deleteBtn.onclick = (e) => {
    e.stopPropagation();
    if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      if (type === "project") {
        data.splice(index, 1);
      } else if (type === "task") {
        parent.children.splice(index, 1);
      }
      saveData();
      render();
    }
    closePopupMenus();
  };
  menu.appendChild(deleteBtn);

  return menu;
}
// é–‹ã„ã¦ã„ã‚‹ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ã‚‹
function closePopupMenus() {
  document.querySelectorAll(".popup-menu").forEach(menu => {
    menu.style.display = "none";
  });
}

// ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã®æ¨ªã«è¡¨ç¤ºã™ã‚‹é–¢æ•°
function togglePopupMenu(titleElem, menu) {
  if (menu.style.display === "block") {
    menu.style.display = "none";
  } else {
    closePopupMenus();

    // è¡¨ç¤ºä½ç½®ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã®ã™ãå³ã«èª¿æ•´
    const rect = titleElem.getBoundingClientRect();
    menu.style.top = (window.scrollY + rect.bottom + 4) + "px";
    menu.style.left = (window.scrollX + rect.left) + "px";
    menu.style.display = "block";
  }
}

function render() {
  const selected = projectFilter.value; // å…ˆã«ç¾åœ¨ã®é¸æŠçŠ¶æ…‹ã‚’ä¿å­˜

  projectList.innerHTML = "";

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚»ãƒ¬ã‚¯ãƒˆã®ä¸­èº«ã‚’å†æ§‹ç¯‰
  projectFilter.innerHTML = '<option value="all">ã™ã¹ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</option>';
  data.forEach((project, index) => {
    const opt = document.createElement("option");
    opt.value = project.name;
    opt.textContent = project.name;
    projectFilter.appendChild(opt);
  });

  // å†æç”»å¾Œã‚‚é¸æŠçŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹
  projectFilter.value = selected;

  // å®Ÿéš›ã®è¡¨ç¤ºå‡¦ç†
  data.forEach((project, index) => {
    if (selected === "all" || selected === project.name) {
      const projectElem = createProjectElement(project, index);
      projectList.appendChild(projectElem);
    }
  });

  initSortable();
}



function initSortable() {
  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¸¦ã¹æ›¿ãˆï¼ˆæœ€ä¸Šä½ï¼‰
  Sortable.create(projectList, {
  animation: 150,
  handle: ".drag-handle", // â† ã“ã“ã§æ´ã‚€å ´æ‰€ã‚’æŒ‡å®š
  onEnd: function (evt) {
    const [moved] = data.splice(evt.oldIndex, 1);
    data.splice(evt.newIndex, 0, moved);
    saveData();
    render(); // â† ã“ã“ã§å†æç”»ã•ã‚Œã¦ã‚‚é †ç•ªã¯ä¿æŒã•ã‚Œã¦ã‚‹
  }
});


  // å…¨ã¦ã® task-list ã«å¯¾ã—ã¦å†å¸°çš„ã«Sortableã‚’åˆæœŸåŒ–
  document.querySelectorAll(".task-list").forEach(list => {
  Sortable.create(list, {
    animation: 150,
    handle: ".drag-handle", // è¿½åŠ ï¼šã“ã‚Œã§ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªéƒ¨åˆ†ã‚’é™å®š
    onEnd: function (evt) {
      const parentInfo = getParentInfo(list);
      if (!parentInfo) return;

      const movedItem = parentInfo.children.splice(evt.oldIndex, 1)[0];
      parentInfo.children.splice(evt.newIndex, 0, movedItem);

      saveData();
      render();
    }
  });
});

}

function findParentArrayByPath(path) {
  const indices = path.split('-').map(Number);
  indices.pop(); // è‡ªåˆ†è‡ªèº«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é™¤ã â†’ è¦ªã®é…åˆ—ã‚’å–å¾—ã™ã‚‹ãŸã‚
  let current = data;
  for (const i of indices) {
    if (!current[i]) return null;
    current = current[i].children;
  }
  return current;
}



function getParentInfo(listElem) {
  // listElemã®è¦ªdivã® task-content > span ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
  const parentContent = listElem.parentElement.querySelector(".task-content > span");
  const parentName = parentContent?.textContent?.trim();
  if (!parentName) return null;

  function findRecursive(nodes, targetName) {
    for (const node of nodes) {
      if (node.name === targetName) {
        return { parent: node, children: node.children || [] };
      }
      if (node.children && node.children.length) {
        const res = findRecursive(node.children, targetName);
        if (res) return res;
      }
    }
    return null;
  }

  return findRecursive(data, parentName);
}


function enableSortable() {
  document.querySelectorAll(".task-list").forEach(list => {
    Sortable.create(list, {
      animation: 150,
      onEnd: function (evt) {
        const listElem = evt.from;
        const info = getParentInfo(listElem);
        if (!info) return;

        const movedItem = info.children.splice(evt.oldIndex, 1)[0];
        info.children.splice(evt.newIndex, 0, movedItem);

        render(); // ä¸¦ã³æ›¿ãˆå¾Œã«å†æç”»
      }
    });
  });
}



function createProjectElement(project, index) {
  const div = document.createElement("div");
  div.className = "project";
  

  const bar = document.createElement("div");
  bar.className = "bar";
  bar.style.backgroundColor = project.color || colors[0];

  const content = document.createElement("div");
  content.className = "task-content";

  const title = document.createElement("span");
  title.textContent = project.name;
const dragHandle = createIconButton("â†•ï¸");
dragHandle.classList.add("drag-handle"); // ã“ã®classã§handleæŒ‡å®šã™ã‚‹
content.appendChild(dragHandle);

const popupMenu = createPopupMenu(project, null, index, "project");
  document.body.appendChild(popupMenu);

  title.addEventListener("click", (e) => {
    e.stopPropagation();
    togglePopupMenu(title, popupMenu);
  });

  const editBtn = createIconButton("âœï¸", () => {
    const newName = prompt("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’ç·¨é›†:", project.name);
    if (newName) {
      project.name = newName;
      saveData();
      render();
    }
  });

  const deleteBtn = createIconButton("ğŸ—‘ï¸", () => {
    if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      data.splice(index, 1);
      saveData();
      render();
    }
  });

  const addSubBtn = createIconButton("â•", () => {
    const name = prompt("å°ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ/ã‚¿ã‚¹ã‚¯å:");
    if (name) {
      if (!project.children) project.children = [];
      project.children.push({ name, children: [], comment: "", done: false });
      saveData();
      render();
    }
  });

  const colorBtn = createIconButton("ğŸ¨", () => {
    const newColor = prompt("0ã€œ9ã®è‰²ç•ªå·ã‚’å…¥åŠ›:\n" + colors.map((c, i) => `${i}: ${c}`).join("\n"));
    const idx = parseInt(newColor);
    if (!isNaN(idx) && colors[idx]) {
      project.color = colors[idx];
      saveData();
      render();
    }
  });

 
  content.appendChild(colorBtn);
   content.appendChild(title);
   content.appendChild(addSubBtn);

  div.appendChild(bar);
  div.appendChild(content);

  // createProjectElement ã®ä¸­
if (project.children) {
  const ul = document.createElement("div");
  ul.className = "task-list";  // â† ã“ã“ã«ã‚¯ãƒ©ã‚¹åã‚’ä»˜ã‘ã¦ã„ã‚‹
  project.children.forEach((child, childIndex) => {
    ul.appendChild(createTaskElement(child, project, childIndex, project.color));
  });
  div.appendChild(ul);
}

  return div;
}

function createTaskElement(task, parent, index, color) {
  const div = document.createElement("div");
  div.className = "task";

  const bar = document.createElement("div");
  bar.className = "bar";
  bar.style.backgroundColor = color;

  const content = document.createElement("div");
  content.className = "task-content";

  const checkbox = document.createElement("input");
  checkbox.type = "checkbox";
  checkbox.checked = task.done;
  checkbox.onchange = () => {
    task.done = checkbox.checked;
    checkAutoComplete(task, parent);
    saveData();
    render();
  };

  const title = document.createElement("span");
title.textContent = task.name;  // å‰ã®ã‚³ãƒ¼ãƒ‰ã¯ " " + task.name ã§ã—ãŸãŒç©ºç™½ã¯å¥½ã¿ã§èª¿æ•´ã—ã¦ãã ã•ã„
const popupMenu = createPopupMenu(task, parent, index, "task");
  document.body.appendChild(popupMenu);

  title.addEventListener("click", (e) => {
    e.stopPropagation();
    togglePopupMenu(title, popupMenu);
  });
const dragHandle = createIconButton("â†•ï¸");
dragHandle.classList.add("drag-handle"); // ã“ã®classã§handleæŒ‡å®šã™ã‚‹
content.appendChild(dragHandle);

if (task.done) {
  title.style.color = "#666666";  // ã‚³ãƒ¡ãƒ³ãƒˆã®è‰²ã¨åˆã‚ã›ã‚‹ãªã‚‰ã“ã®è‰²ã§OK
  title.style.textDecoration = "line-through";
}


  // æœŸé–“è¡¨ç¤ºç”¨ã®spanã‚’è¿½åŠ ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã¨åŒã˜è‰²ã€å°ã•ã„æ–‡å­—ï¼‰
  const periodSpan = document.createElement("span");
  periodSpan.style.fontSize = "12px";
  periodSpan.style.color = "#666";  // ã‚³ãƒ¡ãƒ³ãƒˆã¨åŒã˜è‰²ã«åˆã‚ã›ã‚‹
  periodSpan.style.marginLeft = "6px";
  if(task.startDate && task.endDate) {
    // ä¾‹ãˆã° YYYY-MM-DD â†’ M/D è¡¨ç¤ºã«å¤‰æ›
    const formatDate = (d) => {
      const dt = new Date(d);
      if (isNaN(dt)) return ""; // ç„¡åŠ¹ãªæ—¥ä»˜ã¯ç©ºæ–‡å­—
      return `${dt.getMonth()+1}/${dt.getDate()}`;
    };
    periodSpan.textContent = `(${formatDate(task.startDate)}~${formatDate(task.endDate)})`;
  }

  const commentLine = document.createElement("div");
  commentLine.style.fontSize = "12px";
  commentLine.style.color = "#666";
  commentLine.textContent = task.comment?.split("\n")[0] || "";

  const commentBtn = createIconButton("ğŸ’¬", () => {
    const newComment = prompt("ã‚³ãƒ¡ãƒ³ãƒˆ:", task.comment || "");
    if (newComment != null) {
      task.comment = newComment;
      saveData();
      render();
    }
  });

  // æœŸé–“ç·¨é›†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
  const periodBtn = createIconButton("ğŸ“…", () => {
  showPeriodEditDialog(task);
});


  const addSubBtn = createIconButton("â•", () => {
    const name = prompt("ã‚¿ã‚¹ã‚¯å:");
    if (name) {
      if (!task.children) task.children = [];
      task.children.push({ name, children: [], comment: "", done: false });
      saveData();
      render();
    }
  });

  const editBtn = createIconButton("âœï¸", () => {
    const newName = prompt("ã‚¿ã‚¹ã‚¯åã‚’ç·¨é›†:", task.name);
    if (newName) {
      task.name = newName;
      saveData();
      render();
    }
  });

  const deleteBtn = createIconButton("ğŸ—‘ï¸", () => {
    if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      parent.children.splice(index, 1);
      saveData();
      render();
    }
  });

  content.appendChild(checkbox);
  content.appendChild(title);
  content.appendChild(periodSpan);  // æœŸé–“è¡¨ç¤ºè¿½åŠ 
  content.appendChild(addSubBtn);
  
  
  content.appendChild(commentLine);

  div.appendChild(bar);
  div.appendChild(content);

  if (task.children?.length) {
    const ul = document.createElement("div");
    ul.className = "task-list";
    task.children.forEach((child, childIndex) => {
      ul.appendChild(createTaskElement(child, task, childIndex, color));
    });
    div.appendChild(ul);
  }

  return div;
}
function showPeriodEditDialog(task) {
  // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯
  const modalBg = document.createElement("div");
  modalBg.style.position = "fixed";
  modalBg.style.top = "0";
  modalBg.style.left = "0";
  modalBg.style.width = "100%";
  modalBg.style.height = "100%";
  modalBg.style.backgroundColor = "rgba(0,0,0,0.3)";
  modalBg.style.display = "flex";
  modalBg.style.alignItems = "center";
  modalBg.style.justifyContent = "center";
  modalBg.style.zIndex = "9999";

  // ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“
  const modal = document.createElement("div");
  modal.style.backgroundColor = "white";
  modal.style.padding = "16px";
  modal.style.borderRadius = "8px";
  modal.style.boxShadow = "0 2px 10px rgba(0,0,0,0.2)";
  modal.style.minWidth = "280px";

  const title = document.createElement("h3");
  title.textContent = "æœŸé–“ã‚’é¸æŠ";

  const startLabel = document.createElement("label");
  startLabel.textContent = "é–‹å§‹æ—¥:";
  startLabel.style.display = "block";
  startLabel.style.marginTop = "8px";

  const startInput = document.createElement("input");
  startInput.type = "date";
  startInput.value = task.startDate || "";

  const endLabel = document.createElement("label");
  endLabel.textContent = "çµ‚äº†æ—¥:";
  endLabel.style.display = "block";
  endLabel.style.marginTop = "8px";

  const endInput = document.createElement("input");
  endInput.type = "date";
  endInput.value = task.endDate || "";

  // ãƒœã‚¿ãƒ³
  const btnContainer = document.createElement("div");
  btnContainer.style.marginTop = "12px";
  btnContainer.style.textAlign = "right";

  const cancelBtn = document.createElement("button");
  cancelBtn.textContent = "ã‚­ãƒ£ãƒ³ã‚»ãƒ«";
  cancelBtn.style.marginRight = "8px";

  const okBtn = document.createElement("button");
  okBtn.textContent = "OK";

  cancelBtn.onclick = () => {
    document.body.removeChild(modalBg);
  };

  okBtn.onclick = () => {
    // ç°¡å˜ãªæ—¥ä»˜ãƒã‚§ãƒƒã‚¯ï¼ˆé–‹å§‹æ—¥ <= çµ‚äº†æ—¥ï¼‰
    if (startInput.value && endInput.value && startInput.value > endInput.value) {
      alert("é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ä»¥å‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }
    task.startDate = startInput.value || "";
    task.endDate = endInput.value || "";
    saveData();
    render();
    document.body.removeChild(modalBg);
  };

  btnContainer.appendChild(cancelBtn);
  btnContainer.appendChild(okBtn);

  modal.appendChild(title);
  modal.appendChild(startLabel);
  modal.appendChild(startInput);
  modal.appendChild(endLabel);
  modal.appendChild(endInput);
  modal.appendChild(btnContainer);

  modalBg.appendChild(modal);
  document.body.appendChild(modalBg);
}

function checkAutoComplete(task, parent) {
  if (!parent || !parent.children) return;
  const allDone = parent.children.every(t => t.done);
  if (allDone) parent.done = true;
  else parent.done = false;
}

function createIconButton(icon, action) {
  const btn = document.createElement("button");
  btn.className = "icon-btn";
  btn.innerText = icon;
  btn.onclick = action;
  return btn;
}

addProjectBtn.onclick = () => {
  const name = prompt("ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå:");
  if (name) {
    const color = colors[Math.floor(Math.random() * colors.length)];
    data.push({ name, children: [], color });
    saveData();
    render();
  }
};

render();
</script>
</body>
</html>
